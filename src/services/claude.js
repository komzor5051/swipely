const axios = require('axios');

const OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY;
const CLAUDE_MODEL = 'anthropic/claude-3.5-haiku'; // ะััััะฐั ะธ ะดะตัะตะฒะฐั ะผะพะดะตะปั

/**
 * ะะตะฝะตัะฐัะธั ะบะพะฝัะตะฝัะฐ ะบะฐัััะตะปะธ ัะตัะตะท Claude
 */
async function generateCarouselContent(userText, stylePreset, slideCount = 5, toneGuidelines = null) {
  console.log(`๐ค ะะตะฝะตัะฐัะธั ะบะพะฝัะตะฝัะฐ ัะตัะตะท Claude (ััะธะปั: ${stylePreset}, ัะปะฐะนะดะพะฒ: ${slideCount})...`);

  if (!OPENROUTER_API_KEY) {
    throw new Error('OPENROUTER_API_KEY ะฝะต ะฝะฐัััะพะตะฝ');
  }

  const designConfig = getDesignConfig(stylePreset);
  const systemPrompt = buildSystemPrompt(designConfig, slideCount, toneGuidelines);

  try {
    const response = await axios.post(
      OPENROUTER_API_URL,
      {
        model: CLAUDE_MODEL,
        messages: [
          {
            role: 'system',
            content: systemPrompt
          },
          {
            role: 'user',
            content: `ะกะพะทะดะฐะน ะบะฐัััะตะปั ะฝะฐ ะพัะฝะพะฒะต ััะพะณะพ ัะตะบััะฐ:\n\n"${userText}"`
          }
        ],
        temperature: 0.7,
        max_tokens: 2000
      },
      {
        headers: {
          'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
          'Content-Type': 'application/json',
          'HTTP-Referer': 'https://swipely.ai',
          'X-Title': 'Swipely Telegram Bot'
        }
      }
    );

    const content = response.data.choices[0]?.message?.content;

    if (!content) {
      throw new Error('ะัััะพะน ะพัะฒะตั ะพั Claude');
    }

    // ะะทะฒะปะตะบะฐะตะผ JSON ะธะท ะพัะฒะตัะฐ
    const jsonMatch = content.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      console.error('ะัะฒะตั Claude:', content);
      throw new Error('ะะต ัะดะฐะปะพัั ะธะทะฒะปะตัั JSON ะธะท ะพัะฒะตัะฐ Claude');
    }

    const carouselData = JSON.parse(jsonMatch[0]);

    console.log(`โ ะกะณะตะฝะตัะธัะพะฒะฐะฝะพ ${carouselData.slides?.length || 0} ัะปะฐะนะดะพะฒ`);

    return carouselData;

  } catch (error) {
    console.error('โ ะัะธะฑะบะฐ ะณะตะฝะตัะฐัะธะธ ัะตัะตะท Claude:', error.message);
    throw error;
  }
}

/**
 * ะะพะปััะตะฝะธะต ะบะพะฝัะธะณััะฐัะธะธ ะดะธะทะฐะนะฝะฐ ะฟะพ ะฟัะตัะตัั
 */
function getDesignConfig(stylePreset) {
  const presets = {
    minimal_pop: {
      name: 'Minimal Pop',
      max_words_per_slide: 40,
      accent_color: '#FF0080',
      tone: 'energetic, modern, minimalist',
      template_types: ['headline', 'text-heavy', 'minimalist']
    },
    notebook: {
      name: 'Notebook Sketch',
      max_words_per_slide: 45,
      accent_color: '#FF5722',
      tone: 'personal, educational, handwritten-feel',
      template_types: ['cover', 'dark', 'content']
    },
    darkest: {
      name: 'Darkest Hour',
      max_words_per_slide: 50,
      accent_color: '#FF5500',
      tone: 'professional, elegant, high-contrast',
      template_types: ['cover', 'interface', 'content']
    }
  };

  return presets[stylePreset] || presets.minimal_pop;
}

/**
 * ะะพัััะพะตะฝะธะต ัะธััะตะผะฝะพะณะพ ะฟัะพะผะฟัะฐ ะดะปั Claude
 */
function buildSystemPrompt(designConfig, slideCount, toneGuidelines) {
  const toneSection = toneGuidelines
    ? `\n๐ ะะะะะะ ะขะะะ ะะะะฌะะะะะขะะะฏ (ะบะพะฟะธััะน ััะธะปั ะพะฑัะตะฝะธั):\n${toneGuidelines}\n\nะะะะะะะะะฃะ ะฟัะตะดัะดััะธะต ัะพะพะฑัะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะะะะะขะะะฃะ:\n- ะฃัะพะฒะตะฝั ัะพัะผะฐะปัะฝะพััะธ (ัั/ะฒั)\n- ะะปะธะฝั ะฟัะตะดะปะพะถะตะฝะธะน\n- ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะผะพะดะทะธ ะธ ัะปะตะฝะณะฐ\n- ะขะตะผะฟ ะธะทะปะพะถะตะฝะธั\n- ะัะตะดะฟะพััะธัะตะปัะฝัั ะปะตะบัะธะบั\n\nะะธัะธ ะ ะขะะงะะะกะขะ ะบะฐะบ ััะพั ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐะฟะธัะฐะป ะฑั ัะฐะผ!\n`
    : '\nะะธัะธ ะตััะตััะฒะตะฝะฝะพ, ะบะฐะบ ะถะธะฒะพะน ัะตะปะพะฒะตะบ ะฒ ัะพััะตััั.\n';

  return `ะขั โ ัะพะฟะพะฒัะน SMM-ัััะฐัะตะณ ั 10+ ะณะพะดะฐะผะธ ะพะฟััะฐ ัะพะทะดะฐะฝะธั ะะะะฃะกะะซะฅ ะบะฐัััะตะปะตะน ะดะปั Instagram/Telegram.

ะขะฒะพะธ ะบะฐัััะตะปะธ ะฝะฐะฑะธัะฐัั ะผะธะปะปะธะพะฝั ะฟัะพัะผะพััะพะฒ. ะขั ะทะฝะฐะตัั ะฒัะต ัะตะบัะตัั ะฒะธัะฐะปัะฝะพะณะพ ะบะพะฝัะตะฝัะฐ, ะฟัะธัะพะปะพะณะธัะตัะบะธะต ััะธะณะณะตัั, ะบะพะฟะธัะฐะนัะธะฝะณ-ัะพัะผัะปั ะธ ะฒะธะทัะฐะปัะฝัั ะบะพะผะฟะพะทะธัะธั.

ะะะะะะ-ะะะะกะะข: ${designConfig.name}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะกะขะะฃะะขะฃะะ ะะะะฃะกะะะ ะะะะฃะกะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะะะะะะะ ะกะะะะะะะฏ:
1. ะกะพะทะดะฐะน ะะะะะ ${slideCount} ัะปะฐะนะดะพะฒ ะดะปั Instagram ะบะฐัััะตะปะธ
2. ะะฐะถะดัะน ัะปะฐะนะด: 25-${designConfig.max_words_per_slide} ัะปะพะฒ (ัะฐะทะฒะตัะฝััะพ, ั ะฟัะธะผะตัะฐะผะธ!)
3. ะขะพะฝ: ${designConfig.tone}
4. ะะบัะตะฝัะฝัะน ัะฒะตั: ${designConfig.accent_color}
5. ะขะธะฟั ัะปะฐะนะดะพะฒ: ${designConfig.template_types.join(', ')}

${toneSection}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฅ ะขะะะะะะะะซะ ะะะะะะะะะ (ะะะะขะะงะะกะะ ะะะะะ!)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะะะะะะะะะ = ะฅะฃะ, ะบะพัะพััะน ะทะฐััะฐะฒะปัะตั ะะกะขะะะะะะขะฌะกะฏ ะธ ะฟัะพัะธัะฐัั.

โ ะคะะะะฃะะซ ะะะะฃะกะะซะฅ ะะะะะะะะะะ (ะธัะฟะพะปัะทัะน ะธั!):
โข ะฆะธััั + ะฒัะณะพะดะฐ: "5 ะพัะธะฑะพะบ", "3 ัะฟะพัะพะฑะฐ ะทะฐัะฐะฑะพัะฐัั", "7 ัะตะบัะตัะพะฒ"
โข ะจะพะบะธััััะธะต ัะฐะบัั: "99% ะดะตะปะฐัั ะฝะตะฟัะฐะฒะธะปัะฝะพ", "ะะธะบัะพ ะฝะต ะณะพะฒะพัะธั ะฟัะพ ััะพ"
โข ะะพะปั โ ัะตัะตะฝะธะต: "ะฃััะฐะป ะฟัะพะดะฐะฒะฐัั?", "ะะตั ะฒัะตะผะตะฝะธ ะฝะฐ ะบะพะฝัะตะฝั?"
โข ะัะพัะธะฒะพัะตัะธะต: "ะะตะปะฐะน ะผะตะฝััะต โ ะทะฐัะฐะฑะฐััะฒะฐะน ะฑะพะปััะต"
โข ะัะฑะพะฟััััะฒะพ: "ะกะตะบัะตั, ะบะพัะพััะน ัะบััะฒะฐัั", "ะขะพ, ััะพ ะฒัะต ะฟัะพะฟัััะธะปะธ"
โข ะกัะพัะฝะพััั: "ะะพะบะฐ ะฝะต ะฟะพะทะดะฝะพ", "ะะพัะปะตะดะฝะธะน ัะฐะฝั ัะทะฝะฐัั"
โข ะัะพััะพัะฐ: "ะะฐะบ ะทะฐ 5 ะผะธะฝัั", "ะัะพััะพะน ัะฟะพัะพะฑ"

ะะะะะะะ ะะะะะะะะะะ:
- ะะปะธะฝะฐ: ะกะขะะะะ 3-6 ัะปะพะฒ (ะฝะต ะฑะพะปััะต!)
- ะัะตะณะดะฐ ั ัะธััะฐะผะธ, ะฒะพะฟัะพัะฐะผะธ ะธะปะธ ััะธะณะณะตัะฐะผะธ
- ะะฐะณะพะปะพะฒะพะบ ะดะพะปะถะตะฝ ะะะะะะกะขะฌะฎ ะฟะพะผะตัะฐัััั ะฒ 1 ัััะพะบั
- ะะทะฑะตะณะฐะน: "ะะฐะบ...", "ะะพัะตะผั...", "ะงัะพ ัะฐะบะพะต..." (ััะพ ัะบััะฝะพ!)

โ ะะะะะะะฌะะซะ ะฟัะธะผะตัั:
"5 ะพัะธะฑะพะบ ะฝะพะฒะธัะบะพะฒ"
"ะกะตะบัะตั ะผะธะปะปะธะพะฝะตัะพะฒ"
"ะฃััะฐะป ะฟัะพะดะฐะฒะฐัั?"
"ะะตะปะฐะน ะผะตะฝััะต โ ะทะฐัะฐะฑะพัะฐะน ะฑะพะปััะต"

โ ะะะะะะะะะฌะะซะ (ะะ ะขะะ!):
"ะะฐะบ ะธัะบััััะฒะตะฝะฝัะน ะธะฝัะตะปะปะตะบั ะธะทะผะตะฝะธั ะผะฐัะบะตัะธะฝะณ" (ัะปะธัะบะพะผ ะดะปะธะฝะฝะพ)
"ะะพัะตะผั ะฒะฐะถะฝะพ ะดะตะปะฐัั ะบะพะฝัะตะฝั" (ัะบััะฝะพ, ะฑะตะท ััะธะณะณะตัะฐ)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะคะะะะะขะะะะะะะะ ะะะะขะะะขะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะะปั ะกะะะกะะะ (type: "list"):
- ะัะฟะพะปัะทัะน ัะพัะผะฐั "1. ะะฐะทะฒะฐะฝะธะต: ะะฟะธัะฐะฝะธะต"
- ะะฐะถะดัะน ะฟัะฝะบั ะฝะฐัะธะฝะฐะตััั ั ะะะะะะะ ะฝะฐะทะฒะฐะฝะธั + ะดะฒะพะตัะพัะธะต
- ะะพัะปะต ะดะฒะพะตัะพัะธั โ ัะฐะทะฒะตัะฝััะพะต ะพะฑัััะฝะตะฝะธะต (8-12 ัะปะพะฒ)
- ะัะธะผะตั: "1. GPTunnel: ะะพัะฝัะน ัะพััะธะนัะบะธะน ัะตัะฒะธั ั ะดะพัััะฟะพะผ ะบ GPT-4"

ะะปั ะะะซะงะะะะ ะขะะะกะขะ:
- ะะฐะทะฑะธะฒะฐะน ะฝะฐ ะบะพัะพัะบะธะต ะฐะฑะทะฐัั (2-3 ะฟัะตะดะปะพะถะตะฝะธั)
- ะัะฟะพะปัะทัะน ะบะพะฝะบัะตัะธะบั ะธ ะฟัะธะผะตัั
- ะะพะฑะฐะฒะปัะน ัะธััั, ัะฐะบัั, ััะฐัะธััะธะบั
- ะะทะฑะตะณะฐะน ะฒะพะดั ะธ ะพะฑัะธั ััะฐะท

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฏ ะขะะะซ ะกะะะะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. HOOK (ะฟะตัะฒัะน ัะปะฐะนะด):
   - ะฆะตะปั: ะะะฆะะะะขะฌ ะฒะฝะธะผะฐะฝะธะต ะทะฐ 0.5 ัะตะบัะฝะดั
   - ะะฐะณะพะปะพะฒะพะบ: ะขัะธะณะณะตัะฝัะน, ั ัะธััะพะน ะธะปะธ ะฒะพะฟัะพัะพะผ (3-5 ัะปะพะฒ)
   - Content: ะฃัะธะปะธะฒะฐะตั ััะบ, ะพะฑัััะฝัะตั ัััั (25-30 ัะปะพะฒ)

2. STATEMENT (ััะธะปะตะฝะธะต):
   - ะฆะตะปั: ะะพะดัะฒะตัะดะธัั ะฟัะพะฑะปะตะผั/ะฒะพะทะผะพะถะฝะพััั
   - ะะฐะณะพะปะพะฒะพะบ: ะคะฐะบั, ััะฐัะธััะธะบะฐ ะธะปะธ ะฑะพะปั (3-6 ัะปะพะฒ)
   - Content: ะะฐะทะฒะตัะฝััะพะต ะพะฑัััะฝะตะฝะธะต ั ะฟัะธะผะตัะฐะผะธ

3. LIST (ัะฟะธัะพะบ ัะตัะตะฝะธะน):
   - ะฆะตะปั: ะะฐัั ะบะพะฝะบัะตัะฝัั ะฟะพะปัะทั
   - ะะฐะณะพะปะพะฒะพะบ: "5 ัะฟะพัะพะฑะพะฒ", "3 ะธะฝััััะผะตะฝัะฐ", "7 ัะตะบัะตัะพะฒ"
   - Content: ะะฐะถะดัะน ะฟัะฝะบั = "ะะฐะทะฒะฐะฝะธะต: ะะฟะธัะฐะฝะธะต" (ะธัะฟะพะปัะทัะน format "1. Name: Description")
   - ะกะฟะธัะพะบ ะดะพะปะถะตะฝ ะฑััั ะะฃะะะะะะะะะซะ: "1. ... 2. ... 3. ..."

4. CTA (ะฟัะธะทัะฒ ะบ ะดะตะนััะฒะธั):
   - ะฆะตะปั: ะะพะฝะฒะตััะธัะพะฒะฐัั ะฒ ะฟะพะดะฟะธััะธะบะฐ/ะบะปะธะตะฝัะฐ
   - ะะฐะณะพะปะพะฒะพะบ: "ะะฐัะฝะธ ัะตะณะพะดะฝั", "ะะพะฟัะพะฑัะน ัะตะนัะฐั"
   - Content: ะัะณะบะธะน ะฟัะธะทัะฒ ั ะฒัะณะพะดะพะน

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะกะะะะะขะซ ะะะะะะฌะะะะ ะะะะขะะะขะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. ะัะบัะพะน ั ะะะะ ะธะปะธ ะะะะะะะฏ (ะฝะต ั ัะตะพัะธะธ!)
2. ะัะฟะพะปัะทัะน ะบะพะฝะบัะตัะฝัะต ัะธััั ะธ ัะฐะบัั
3. ะะพะฑะฐะฒั ะปะธัะฝัะน ะพะฟัั ะธะปะธ ะบะตะนัั
4. ะะธัะธ ะฟัะพััะพ (ััะพะฒะตะฝั 8 ะบะปะฐััะฐ)
5. ะะฐะถะดัะน ัะปะฐะนะด = ะะะะ ะผััะปั (ะฝะต ะฑะพะปััะต!)
6. ะคะธะฝะฐะป = CTA ั ะฒัะณะพะดะพะน (ะฝะต ะฟัะพััะพ "ะฟะพะดะฟะธัะธัั")

OUTPUT ONLY valid JSON:
{
  "slides": [
    {
      "type": "hook",
      "title": "5 ะพัะธะฑะพะบ ะฝะพะฒะธัะบะพะฒ",
      "content": "ะะฐะถะดัะน ะฝะฐัะธะฝะฐััะธะน ะผะฐัะบะตัะพะปะพะณ ัะพะฒะตััะฐะตั ััะธ ะพัะธะฑะบะธ. ะะฝะธ ััะพัั ัััััะธ ััะฑะปะตะน ะธ ะผะตัััั ะฟะพัะตััะฝะฝะพะณะพ ะฒัะตะผะตะฝะธ. ะฃะทะฝะฐะน, ะบะฐะบ ะธั ะธะทะฑะตะถะฐัั ะธ ะฝะฐัะฐัั ะทะฐัะฐะฑะฐััะฒะฐัั ั ะฟะตัะฒะพะณะพ ะดะฝั.",
      "emphasize": ["ะพัะธะฑะบะธ", "ะธะทะฑะตะถะฐัั"],
      "template_id": "${designConfig.template_types[0]}"
    }
  ]
}

ะะตะฝะตัะธััะน ะขะะะฌะะ JSON, ะฑะตะท ะบะพะผะผะตะฝัะฐัะธะตะฒ ะธ ะฟะพััะฝะตะฝะธะน.`;
}

/**
 * ะะฝะฐะปะธะท tone of voice ะฟะพะปัะทะพะฒะฐัะตะปั
 */
async function analyzeToneOfVoice(text) {
  console.log('๐ค ะะฝะฐะปะธะท tone of voice...');

  if (!OPENROUTER_API_KEY) {
    return null;
  }

  try {
    const response = await axios.post(
      OPENROUTER_API_URL,
      {
        model: CLAUDE_MODEL,
        messages: [
          {
            role: 'system',
            content: `ะัะพะฐะฝะฐะปะธะทะธััะน ััะธะปั ัะตัะธ ะฟะพะปัะทะพะฒะฐัะตะปั.

OUTPUT ONLY valid JSON:
{
  "sentence_length": "short" | "medium" | "long",
  "tone": "friendly" | "expert" | "motivational" | "sarcastic" | "confident",
  "signature_words": ["ัะปะพะฒะพ1", "ัะปะพะฒะพ2"],
  "emoji_usage": "none" | "moderate" | "heavy",
  "formality": "casual" | "formal"
}`
          },
          {
            role: 'user',
            content: text
          }
        ],
        temperature: 0.5,
        max_tokens: 500
      },
      {
        headers: {
          'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
          'Content-Type': 'application/json',
          'HTTP-Referer': 'https://swipely.ai',
          'X-Title': 'Swipely Telegram Bot - Tone Analysis'
        }
      }
    );

    const content = response.data.choices[0]?.message?.content;
    const jsonMatch = content.match(/\{[\s\S]*\}/);

    if (jsonMatch) {
      const toneData = JSON.parse(jsonMatch[0]);
      console.log('โ Tone of voice ะฟัะพะฐะฝะฐะปะธะทะธัะพะฒะฐะฝ:', toneData);
      return toneData;
    }

    return null;

  } catch (error) {
    console.error('โ ะัะธะฑะบะฐ ะฐะฝะฐะปะธะทะฐ tone:', error.message);
    return null;
  }
}

module.exports = {
  generateCarouselContent,
  analyzeToneOfVoice
};
