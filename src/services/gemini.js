const { GoogleGenerativeAI } = require('@google/generative-ai');

const GOOGLE_API_KEY = process.env.GOOGLE_GEMINI_API_KEY;

// –ú–æ–¥–µ–ª–∏ Gemini (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞ —è–Ω–≤–∞—Ä—å 2026)
const GEMINI_MODELS = {
  FLASH_25: 'gemini-2.5-flash',              // –°—Ç–∞–±–∏–ª—å–Ω–∞—è, –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω–∞/–∫–∞—á–µ—Å—Ç–≤–æ
  FLASH_3: 'gemini-3-flash-preview',         // –°–∞–º–∞—è –Ω–æ–≤–∞—è, —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è
  PRO_3: 'gemini-3-pro-preview',             // –°–∞–º–∞—è –º–æ—â–Ω–∞—è
  FLASH_LITE: 'gemini-2.5-flash-lite'        // –°–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è –∏ –¥–µ—à–µ–≤–∞—è
};

// –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º—É—é –ª–µ–≥–∫—É—é –º–æ–¥–µ–ª—å Flash Lite (–º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞)
const DEFAULT_MODEL = GEMINI_MODELS.FLASH_LITE; // gemini-2.5-flash-lite

let genAI = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Gemini
function initGemini() {
  if (!GOOGLE_API_KEY) {
    console.error('‚ùå GOOGLE_GEMINI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    return null;
  }

  if (!genAI) {
    genAI = new GoogleGenerativeAI(GOOGLE_API_KEY);
    console.log('‚úÖ Google Gemini –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
  }

  return genAI;
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–∞—Ä—É—Å–µ–ª–∏ —á–µ—Ä–µ–∑ Google Gemini
 */
async function generateCarouselContent(userText, stylePreset, slideCount = 5, toneGuidelines = null, modelName = DEFAULT_MODEL) {
  console.log(`ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Gemini (–º–æ–¥–µ–ª—å: ${modelName}, —Å—Ç–∏–ª—å: ${stylePreset}, —Å–ª–∞–π–¥–æ–≤: ${slideCount})...`);

  const ai = initGemini();
  if (!ai) {
    throw new Error('Google Gemini API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
  }

  const designConfig = getDesignConfig(stylePreset);
  const systemPrompt = buildSystemPrompt(designConfig, slideCount, toneGuidelines);

  // Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (503)
  const maxRetries = 3;
  let content = null;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const model = ai.getGenerativeModel({
        model: modelName,
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 2000,
        }
      });

      // Gemini –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç: –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º + –∑–∞–ø—Ä–æ—Å
      const fullPrompt = `${systemPrompt}

USER REQUEST:
–°–æ–∑–¥–∞–π –∫–∞—Ä—É—Å–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:

"${userText}"`;

      console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}/${maxRetries}...`);
      const result = await model.generateContent(fullPrompt);
      const response = await result.response;
      content = response.text();

      // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ - –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
      break;
    } catch (error) {
      // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ 503 (–ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞) –∏ –µ—Å—Ç—å –µ—â–µ –ø–æ–ø—ã—Ç–∫–∏ - –∂–¥–µ–º –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º
      if (error.status === 503 && attempt < maxRetries) {
        const waitTime = attempt * 2; // 2s, 4s, 6s
        console.log(`‚è≥ –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω, –∂–¥—É ${waitTime} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...`);
        await new Promise(resolve => setTimeout(resolve, waitTime * 1000));
        continue;
      }

      // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
      console.error(`‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Gemini (–ø–æ–ø—ã—Ç–∫–∞ ${attempt}/${maxRetries}):`, error.message);
      throw error;
    }
  }

  try {

    if (!content) {
      throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini');
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ (Gemini –º–æ–∂–µ—Ç –æ–±–µ—Ä–Ω—É—Ç—å –≤ ```json)
    let cleanedContent = content.trim();

    // –£–¥–∞–ª—è–µ–º markdown –æ–±–µ—Ä—Ç–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (cleanedContent.startsWith('```json')) {
      cleanedContent = cleanedContent.replace(/^```json\s*\n/, '').replace(/\n```\s*$/, '');
    } else if (cleanedContent.startsWith('```')) {
      cleanedContent = cleanedContent.replace(/^```\s*\n/, '').replace(/\n```\s*$/, '');
    }

    const jsonMatch = cleanedContent.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      console.error('–û—Ç–≤–µ—Ç Gemini:', content);
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ Gemini');
    }

    const carouselData = JSON.parse(jsonMatch[0]);

    console.log(`‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${carouselData.slides?.length || 0} —Å–ª–∞–π–¥–æ–≤ —á–µ—Ä–µ–∑ Gemini`);

    return carouselData;

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Gemini:', error.message);
    throw error;
  }
}

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–∏–∑–∞–π–Ω–∞ –ø–æ –ø—Ä–µ—Å–µ—Ç—É
 * (–ö–æ–ø–∏—è –∏–∑ claude.js –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
 */
function getDesignConfig(stylePreset) {
  const presets = {
    minimal_pop: {
      name: 'Minimal Pop',
      max_words_per_slide: 40,
      accent_color: '#FF0080',
      tone: 'energetic, modern, minimalist',
      template_types: ['headline', 'text-heavy', 'minimalist']
    },
    notebook: {
      name: 'Notebook Sketch',
      max_words_per_slide: 45,
      accent_color: '#FF5722',
      tone: 'personal, educational, handwritten-feel',
      template_types: ['cover', 'dark', 'content']
    },
    darkest: {
      name: 'Darkest Hour',
      max_words_per_slide: 50,
      accent_color: '#FF5500',
      tone: 'professional, elegant, high-contrast',
      template_types: ['cover', 'interface', 'content']
    }
  };

  return presets[stylePreset] || presets.minimal_pop;
}

/**
 * –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è Gemini
 * (–ò–¥–µ–Ω—Ç–∏—á–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∫–∞–∫ —É Claude –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
 */
function buildSystemPrompt(designConfig, slideCount, toneGuidelines) {
  const toneSection = toneGuidelines
    ? `\nüìù –ê–ù–ê–õ–ò–ó –¢–û–ù–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–∫–æ–ø–∏—Ä—É–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è):\n${toneGuidelines}\n\n–ê–ù–ê–õ–ò–ó–ò–†–£–ô –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ê–î–ê–ü–¢–ò–†–£–ô:\n- –£—Ä–æ–≤–µ–Ω—å —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏ (—Ç—ã/–≤—ã)\n- –î–ª–∏–Ω—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π\n- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏ –∏ —Å–ª–µ–Ω–≥–∞\n- –¢–µ–º–ø –∏–∑–ª–æ–∂–µ–Ω–∏—è\n- –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—É—é –ª–µ–∫—Å–∏–∫—É\n\n–ü–∏—à–∏ –í –¢–û–ß–ù–û–°–¢–ò –∫–∞–∫ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª –±—ã —Å–∞–º!\n`
    : '\n–ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö.\n';

  return `–¢—ã ‚Äî —Ç–æ–ø–æ–≤—ã–π SMM-—Å—Ç—Ä–∞—Ç–µ–≥ —Å 10+ –≥–æ–¥–∞–º–∏ –æ–ø—ã—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –í–ò–†–£–°–ù–´–• –∫–∞—Ä—É—Å–µ–ª–µ–π –¥–ª—è Instagram/Telegram.

–¢–≤–æ–∏ –∫–∞—Ä—É—Å–µ–ª–∏ –Ω–∞–±–∏—Ä–∞—é—Ç –º–∏–ª–ª–∏–æ–Ω—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤. –¢—ã –∑–Ω–∞–µ—à—å –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤–∏—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã, –∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥-—Ñ–æ—Ä–º—É–ª—ã –∏ –≤–∏–∑—É–∞–ª—å–Ω—É—é –∫–æ–º–ø–æ–∑–∏—Ü–∏—é.

–î–ò–ó–ê–ô–ù-–ü–†–ï–°–ï–¢: ${designConfig.name}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä –°–¢–†–£–ö–¢–£–†–ê –í–ò–†–£–°–ù–û–ô –ö–ê–†–£–°–ï–õ–ò
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü–†–ê–í–ò–õ–ê –°–û–ó–î–ê–ù–ò–Ø:
1. –°–æ–∑–¥–∞–π –†–û–í–ù–û ${slideCount} —Å–ª–∞–π–¥–æ–≤ –¥–ª—è Instagram –∫–∞—Ä—É—Å–µ–ª–∏
2. –ö–∞–∂–¥—ã–π —Å–ª–∞–π–¥: 25-${designConfig.max_words_per_slide} —Å–ª–æ–≤ (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ, —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏!)
3. –¢–æ–Ω: ${designConfig.tone}
4. –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç: ${designConfig.accent_color}
5. –¢–∏–ø—ã —Å–ª–∞–π–¥–æ–≤: ${designConfig.template_types.join(', ')}

${toneSection}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üî• –¢–†–ò–ì–ì–ï–†–ù–´–ï –ó–ê–ì–û–õ–û–í–ö–ò (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ó–ê–ì–û–õ–û–í–û–ö = –•–£–ö, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –û–°–¢–ê–ù–û–í–ò–¢–¨–°–Ø –∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å.

‚úÖ –§–û–†–ú–£–õ–´ –í–ò–†–£–°–ù–´–• –ó–ê–ì–û–õ–û–í–ö–û–í (–∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö!):
‚Ä¢ –¶–∏—Ñ—Ä—ã + –≤—ã–≥–æ–¥–∞: "5 –æ—à–∏–±–æ–∫", "3 —Å–ø–æ—Å–æ–±–∞ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å", "7 —Å–µ–∫—Ä–µ—Ç–æ–≤"
‚Ä¢ –®–æ–∫–∏—Ä—É—é—â–∏–µ —Ñ–∞–∫—Ç—ã: "99% –¥–µ–ª–∞—é—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ", "–ù–∏–∫—Ç–æ –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ —ç—Ç–æ"
‚Ä¢ –ë–æ–ª—å ‚Üí —Ä–µ—à–µ–Ω–∏–µ: "–£—Å—Ç–∞–ª –ø—Ä–æ–¥–∞–≤–∞—Ç—å?", "–ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç?"
‚Ä¢ –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ: "–î–µ–ª–∞–π –º–µ–Ω—å—à–µ ‚Äî –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –±–æ–ª—å—à–µ"
‚Ä¢ –õ—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ: "–°–µ–∫—Ä–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–∫—Ä—ã–≤–∞—é—Ç", "–¢–æ, —á—Ç–æ –≤—Å–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏"
‚Ä¢ –°—Ä–æ—á–Ω–æ—Å—Ç—å: "–ü–æ–∫–∞ –Ω–µ –ø–æ–∑–¥–Ω–æ", "–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å —É–∑–Ω–∞—Ç—å"
‚Ä¢ –ü—Ä–æ—Å—Ç–æ—Ç–∞: "–ö–∞–∫ –∑–∞ 5 –º–∏–Ω—É—Ç", "–ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±"

–ü–†–ê–í–ò–õ–ê –ó–ê–ì–û–õ–û–í–ö–û–í:
- –î–ª–∏–Ω–∞: –°–¢–†–û–ì–û 3-6 —Å–ª–æ–≤ (–Ω–µ –±–æ–ª—å—à–µ!)
- –í—Å–µ–≥–¥–∞ —Å —Ü–∏—Ñ—Ä–∞–º–∏, –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–ª–∂–µ–Ω –ü–û–õ–ù–û–°–¢–¨–Æ –ø–æ–º–µ—â–∞—Ç—å—Å—è –≤ 1 —Å—Ç—Ä–æ–∫—É
- –ò–∑–±–µ–≥–∞–π: "–ö–∞–∫...", "–ü–æ—á–µ–º—É...", "–ß—Ç–æ —Ç–∞–∫–æ–µ..." (—ç—Ç–æ —Å–∫—É—á–Ω–æ!)

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ï –ø—Ä–∏–º–µ—Ä—ã:
"5 –æ—à–∏–±–æ–∫ –Ω–æ–≤–∏—á–∫–æ–≤"
"–°–µ–∫—Ä–µ—Ç –º–∏–ª–ª–∏–æ–Ω–µ—Ä–æ–≤"
"–£—Å—Ç–∞–ª –ø—Ä–æ–¥–∞–≤–∞—Ç—å?"
"–î–µ–ª–∞–π –º–µ–Ω—å—à–µ ‚Äî –∑–∞—Ä–∞–±–æ—Ç–∞–π –±–æ–ª—å—à–µ"

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ï (–ù–ï –¢–ê–ö!):
"–ö–∞–∫ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∏–∑–º–µ–Ω–∏—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥" (—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ)
"–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç" (—Å–∫—É—á–Ω–æ, –±–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä–∞)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìù –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ù–¢–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–î–ª—è –°–ü–ò–°–ö–û–í (type: "list"):
- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç "1. –ù–∞–∑–≤–∞–Ω–∏–µ: –û–ø–∏—Å–∞–Ω–∏–µ"
- –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ñ–ò–†–ù–û–ì–û –Ω–∞–∑–≤–∞–Ω–∏—è + –¥–≤–æ–µ—Ç–æ—á–∏–µ
- –ü–æ—Å–ª–µ –¥–≤–æ–µ—Ç–æ—á–∏—è ‚Äî —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (8-12 —Å–ª–æ–≤)
- –ü—Ä–∏–º–µ—Ä: "1. GPTunnel: –ú–æ—â–Ω—ã–π —Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ GPT-4"

–î–ª—è –û–ë–´–ß–ù–û–ì–û –¢–ï–ö–°–¢–ê:
- –†–∞–∑–±–∏–≤–∞–π –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É –∏ –ø—Ä–∏–º–µ—Ä—ã
- –î–æ–±–∞–≤–ª—è–π —Ü–∏—Ñ—Ä—ã, —Ñ–∞–∫—Ç—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- –ò–∑–±–µ–≥–∞–π –≤–æ–¥—ã –∏ –æ–±—â–∏—Ö —Ñ—Ä–∞–∑

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéØ –¢–ò–ü–´ –°–õ–ê–ô–î–û–í
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. HOOK (–ø–µ—Ä–≤—ã–π —Å–ª–∞–π–¥):
   - –¶–µ–ª—å: –ó–ê–¶–ï–ü–ò–¢–¨ –≤–Ω–∏–º–∞–Ω–∏–µ –∑–∞ 0.5 —Å–µ–∫—É–Ω–¥—ã
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫: –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–π, —Å —Ü–∏—Ñ—Ä–æ–π –∏–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–º (3-5 —Å–ª–æ–≤)
   - Content: –£—Å–∏–ª–∏–≤–∞–µ—Ç —Ö—É–∫, –æ–±—ä—è—Å–Ω—è–µ—Ç —Å—É—Ç—å (25-30 —Å–ª–æ–≤)

2. STATEMENT (—É—Å–∏–ª–µ–Ω–∏–µ):
   - –¶–µ–ª—å: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫: –§–∞–∫—Ç, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–ª–∏ –±–æ–ª—å (3-6 —Å–ª–æ–≤)
   - Content: –†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏

3. LIST (—Å–ø–∏—Å–æ–∫ —Ä–µ—à–µ–Ω–∏–π):
   - –¶–µ–ª—å: –î–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–ª—å–∑—É
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫: "5 —Å–ø–æ—Å–æ–±–æ–≤", "3 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞", "7 —Å–µ–∫—Ä–µ—Ç–æ–≤"
   - Content: –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç = "–ù–∞–∑–≤–∞–Ω–∏–µ: –û–ø–∏—Å–∞–Ω–∏–µ" (–∏—Å–ø–æ–ª—å–∑—É–π format "1. Name: Description")
   - –°–ø–∏—Å–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ù–£–ú–ï–†–û–í–ê–ù–ù–´–ú: "1. ... 2. ... 3. ..."

4. CTA (–ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é):
   - –¶–µ–ª—å: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞/–∫–ª–∏–µ–Ω—Ç–∞
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–ù–∞—á–Ω–∏ —Å–µ–≥–æ–¥–Ω—è", "–ü–æ–ø—Ä–æ–±—É–π —Å–µ–π—á–∞—Å"
   - Content: –ú—è–≥–∫–∏–π –ø—Ä–∏–∑—ã–≤ —Å –≤—ã–≥–æ–¥–æ–π

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üíé –°–ï–ö–†–ï–¢–´ –í–ò–†–ê–õ–¨–ù–û–ì–û –ö–û–ù–¢–ï–ù–¢–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. –û—Ç–∫—Ä–æ–π —Å –ë–û–õ–ò –∏–ª–∏ –ñ–ï–õ–ê–ù–ò–Ø (–Ω–µ —Å —Ç–µ–æ—Ä–∏–∏!)
2. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ñ–∞–∫—Ç—ã
3. –î–æ–±–∞–≤—å –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç –∏–ª–∏ –∫–µ–π—Å—ã
4. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ (—É—Ä–æ–≤–µ–Ω—å 8 –∫–ª–∞—Å—Å–∞)
5. –ö–∞–∂–¥—ã–π —Å–ª–∞–π–¥ = –û–î–ù–ê –º—ã—Å–ª—å (–Ω–µ –±–æ–ª—å—à–µ!)
6. –§–∏–Ω–∞–ª = CTA —Å –≤—ã–≥–æ–¥–æ–π (–Ω–µ –ø—Ä–æ—Å—Ç–æ "–ø–æ–¥–ø–∏—à–∏—Å—å")

OUTPUT ONLY valid JSON:
{
  "slides": [
    {
      "type": "hook",
      "title": "5 –æ—à–∏–±–æ–∫ –Ω–æ–≤–∏—á–∫–æ–≤",
      "content": "–ö–∞–∂–¥—ã–π –Ω–∞—á–∏–Ω–∞—é—â–∏–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ —Å–æ–≤–µ—Ä—à–∞–µ—Ç —ç—Ç–∏ –æ—à–∏–±–∫–∏. –û–Ω–∏ —Å—Ç–æ—è—Ç —Ç—ã—Å—è—á–∏ —Ä—É–±–ª–µ–π –∏ –º–µ—Å—è—Ü—ã –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –£–∑–Ω–∞–π, –∫–∞–∫ –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å –∏ –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è.",
      "emphasize": ["–æ—à–∏–±–∫–∏", "–∏–∑–±–µ–∂–∞—Ç—å"],
      "template_id": "${designConfig.template_types[0]}"
    }
  ]
}

–ì–µ–Ω–µ—Ä–∏—Ä—É–π –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`;
}

/**
 * –ê–Ω–∞–ª–∏–∑ tone of voice –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Gemini
 */
async function analyzeToneOfVoice(text, modelName = DEFAULT_MODEL) {
  console.log('üé§ –ê–Ω–∞–ª–∏–∑ tone of voice —á–µ—Ä–µ–∑ Gemini...');

  const ai = initGemini();
  if (!ai) {
    return null;
  }

  try {
    const model = ai.getGenerativeModel({
      model: modelName,
      generationConfig: {
        temperature: 0.5,
        maxOutputTokens: 500,
      }
    });

    const prompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç–∏–ª—å —Ä–µ—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

OUTPUT ONLY valid JSON:
{
  "sentence_length": "short" | "medium" | "long",
  "tone": "friendly" | "expert" | "motivational" | "sarcastic" | "confident",
  "signature_words": ["—Å–ª–æ–≤–æ1", "—Å–ª–æ–≤–æ2"],
  "emoji_usage": "none" | "moderate" | "heavy",
  "formality": "casual" | "formal"
}

USER TEXT:
${text}`;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const content = response.text();

    // –û—á–∏—â–∞–µ–º markdown –æ–±–µ—Ä—Ç–∫–∏
    let cleanedContent = content.trim();
    if (cleanedContent.startsWith('```json')) {
      cleanedContent = cleanedContent.replace(/^```json\s*\n/, '').replace(/\n```\s*$/, '');
    } else if (cleanedContent.startsWith('```')) {
      cleanedContent = cleanedContent.replace(/^```\s*\n/, '').replace(/\n```\s*$/, '');
    }

    const jsonMatch = cleanedContent.match(/\{[\s\S]*\}/);

    if (jsonMatch) {
      const toneData = JSON.parse(jsonMatch[0]);
      console.log('‚úÖ Tone of voice –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Gemini:', toneData);
      return toneData;
    }

    return null;

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ tone —á–µ—Ä–µ–∑ Gemini:', error.message);
    return null;
  }
}

module.exports = {
  generateCarouselContent,
  analyzeToneOfVoice,
  GEMINI_MODELS,
  DEFAULT_MODEL
};
